From 77db00da6b4c11214461ee17288ac3b12c4cc950 Mon Sep 17 00:00:00 2001
From: Cody P Schafer <dev@codyps.com>
Date: Wed, 19 Nov 2014 13:58:57 -0500
Subject: [PATCH] mk: instead of lieing about stage0 libdir, pass flags to the
 compiler to force the right libdirs

---
 mk/main.mk   | 14 ++++++++++++--
 mk/target.mk |  1 +
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/mk/main.mk b/mk/main.mk
index 676ea21..3e070c2 100644
--- a/mk/main.mk
+++ b/mk/main.mk
@@ -340,17 +340,26 @@ ifeq ($(1)-$(3),0-$$(CFG_BUILD))
 # libdir. At the moment, this assumes the relative paths (from sysroot aka
 # prefix) are 'lib' and 'bin'.
 HBIN$(1)_H_$(3) = $$(HROOT$(1)_H_$(3))/bin
-HLIB$(1)_H_$(3) = $$(HROOT$(1)_H_$(3))/lib
 else
 HBIN$(1)_H_$(3) = $$(HROOT$(1)_H_$(3))/$$(CFG_BINDIR_RELATIVE)
-HLIB$(1)_H_$(3) = $$(HROOT$(1)_H_$(3))/$$(CFG_LIBDIR_RELATIVE)
 endif
 
+HLIB$(1)_H_$(3) = $$(HROOT$(1)_H_$(3))/$$(CFG_LIBDIR_RELATIVE)
+
 # Destinations of artifacts for target architectures
 TROOT$(1)_T_$(2)_H_$(3) = $$(HLIB$(1)_H_$(3))/rustlib/$(2)
 TBIN$(1)_T_$(2)_H_$(3) = $$(TROOT$(1)_T_$(2)_H_$(3))/bin
 TLIB$(1)_T_$(2)_H_$(3) = $$(TROOT$(1)_T_$(2)_H_$(3))/lib
 
+# Don't trust stage0, be explicit about libraries
+# TODO: rather than specifying sysroot, we really want to tell which libdir to
+#       use (ie: the dir containing 'rustlib'). This would allow us to avoid
+#       passing the '-L' options.
+ifeq ($(1), 0)
+RUSTFLAGS_S_$(1)_T_$(2)_H_$(3) += --sysroot "$$(HROOT$(1)_H_$(3))" \
+				  -L "$$(TLIB$(1)_T_$(2)_H_$(3)"
+endif
+
 # Preqrequisites for using the stageN compiler
 ifeq ($(1),0)
 HSREQ$(1)_H_$(3) = $$(HBIN$(1)_H_$(3))/rustc$$(X_$(3))
-- 
2.1.3

